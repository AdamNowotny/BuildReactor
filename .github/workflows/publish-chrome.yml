name: Publish to Chrome Web Store

on:
    workflow_dispatch:
        inputs:
            release_tag:
                description: 'Release tag to publish (e.g., v5.0.0). Leave empty to use latest release.'
                required: false
                type: string

jobs:
    publish-chrome:
        runs-on: ubuntu-latest
        steps:
            - name: Get release info
              id: get-release
              run: |
                  if [ -n "${{ github.event.inputs.release_tag }}" ]; then
                    RELEASE_URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.event.inputs.release_tag }}"
                  else
                    RELEASE_URL="https://api.github.com/repos/${{ github.repository }}/releases/latest"
                  fi
                  
                  RELEASE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$RELEASE_URL")
                  echo "tag=$(echo "$RELEASE_DATA" | jq -r .tag_name)" >> $GITHUB_OUTPUT
                  echo "upload_url=$(echo "$RELEASE_DATA" | jq -r .upload_url)" >> $GITHUB_OUTPUT
                  echo "RELEASE_DATA<<EOF" >> $GITHUB_OUTPUT
                  echo "$RELEASE_DATA" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Download Chrome extension asset
              run: |
                  VERSION=$(echo '${{ steps.get-release.outputs.RELEASE_DATA }}' | jq -r .tag_name | sed 's/^v//')
                  ASSET_NAME="build-reactor-chrome-v${VERSION}.zip"
                  
                  echo "Looking for asset: $ASSET_NAME"
                  
                  DOWNLOAD_URL=$(echo '${{ steps.get-release.outputs.RELEASE_DATA }}' | jq -r ".assets[] | select(.name == \"$ASSET_NAME\") | .url")
                  
                  if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
                    echo "Asset $ASSET_NAME not found. Available assets:"
                    echo '${{ steps.get-release.outputs.RELEASE_DATA }}' | jq -r '.assets[].name'
                    exit 1
                  fi
                  
                  curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                       -H "Accept: application/octet-stream" \
                       "$DOWNLOAD_URL" -o build-reactor-chrome.zip
                  
                  echo "Downloaded Chrome extension package"
                  ls -la build-reactor-chrome.zip

            - name: Upload to Chrome Web Store
              uses: mnao305/chrome-extension-upload@5.0.0
              with:
                  file-path: build-reactor-chrome.zip
                  extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
                  client-id: ${{ secrets.CHROME_CLIENT_ID }}
                  client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
                  refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
                  publish: false

            - name: Log success
              run: |
                  echo "âœ… Chrome extension uploaded successfully!"
                  echo "Version: ${{ steps.get-release.outputs.tag }}"
                  echo "Status: Submitted for review (not yet published)"
                  echo ""
                  echo "Visit https://chrome.google.com/webstore/devconsole to review and publish."
